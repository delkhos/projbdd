CREATE EXTENSION pg_trgm;

CREATE TABLE pays (
nom_pays                  varchar(250) UNIQUE PRIMARY KEY
);

CREATE TABLE musee (
nom_musee                 varchar(250) UNIQUE primary key,
adresse                   varchar(250),
prix_entree               real,
pays                      varchar(250) references pays(nom_pays)
);

CREATE TABLE users (
id                        SERIAL PRIMARY KEY,
username                  VARCHAR(50) NOT NULL UNIQUE,
password                  VARCHAR(255) NOT NULL,
admin                     BOOLEAN NOT NULL,
handeld_musee             varchar(250) references musee(nom_musee),
don_mensuel               real DEFAULT 0,
created_at                date DEFAULT CURRENT_DATE
);

CREATE TYPE type_don AS ENUM ('mensuel', 'ponctuel');

CREATE TABLE don (
don_id                    SERIAL primary key,
date                      date DEFAULT CURRENT_DATE,
valeur                    real,
type                      type_don,
musee                     varchar(250) references musee(nom_musee),
mecene                    integer references users(id)
);

CREATE TYPE type_oeuvre AS ENUM ('peinture', 'sculpture', 'photographie');


CREATE TABLE artiste (
nom_artiste               varchar(250) primary key,
date_naissance            date,
date_mort                 date,
nationalite               varchar(250) references pays(nom_pays),
biographie                varchar(1000)
);

CREATE TABLE courant_artistique (
nom_courant               varchar(250) UNIQUE primary key,
date_debut                integer,
date_fin                  integer,
description               varchar(1000)
);

CREATE TABLE participation_courant(
nom_courant               varchar(250) references courant_artistique(nom_courant),
artiste                   varchar(250) references artiste(nom_artiste)
);

CREATE TYPE type_expo AS ENUM('perm','tempop','tempoc','tempoa');

CREATE TABLE expo_ids (
expo_id                   SERIAL PRIMARY KEY,
expo_type                 type_expo NOT NULL
);

CREATE TABLE exposition_permanente(
expo_id                   integer unique primary key references expo_ids(expo_id),
nom_expo                       varchar(250),
musee                     varchar(250) references musee(nom_musee)
);

CREATE TABLE exposition_temporaire_pays (
expo_id                   integer unique primary key references expo_ids(expo_id),
nom_expo                       varchar(250),
musee                     varchar(250) references musee(nom_musee),
date_debut                date,
date_fin                  date,
pays                      varchar(250) references pays(nom_pays)
);


CREATE TABLE exposition_temporaire_artiste (
expo_id                   integer unique primary key references expo_ids(expo_id),
nom_expo                       varchar(250),
musee                     varchar(250) references musee(nom_musee),
date_debut                date,
date_fin                  date,
artiste                   varchar(250) references artiste(nom_artiste)
);

CREATE TABLE exposition_temporaire_courant (
expo_id                   integer unique primary key references expo_ids(expo_id),
nom_expo                       varchar(250),
musee                     varchar(250) references musee(nom_musee),
date_debut                date,
date_fin                  date,
courant       varchar(250) references courant_artistique(nom_courant)
);

CREATE VIEW expositions AS
  SELECT expo_id, nom_expo, musee FROM exposition_permanente
    UNION
  SELECT expo_id, nom_expo, musee FROM exposition_temporaire_artiste 
UNION
SELECT expo_id, nom_expo, musee FROM exposition_temporaire_pays 
UNION
SELECT expo_id, nom_expo, musee FROM exposition_temporaire_courant;

CREATE VIEW expositions_sans_musee AS
  SELECT expo_id, nom_expo FROM exposition_permanente
    UNION
  SELECT expo_id, nom_expo FROM exposition_temporaire_artiste 
UNION
SELECT expo_id, nom_expo FROM exposition_temporaire_pays 
UNION
SELECT expo_id, nom_expo FROM exposition_temporaire_courant;

CREATE TABLE participation_expo(
expo                      integer references expo_ids(expo_id),
musee                     varchar(250) references musee(nom_musee)
);

CREATE TABLE oeuvre (
oeuvre_id                 SERIAL primary key,
nom_oeuvre                varchar(250),
date                      integer,
description               varchar(5000),
type                      type_oeuvre,
musee                     varchar(250) references musee(nom_musee),
exposition                integer references expo_ids(expo_id),
artiste                   varchar(250) references artiste(nom_artiste),
courant_artistique        varchar references courant_artistique(nom_courant)
);

INSERT INTO pays (nom_pays)
  VALUES ('France');

INSERT INTO artiste (nom_artiste, date_naissance ,date_mort ,nationalite ,biographie)
  VALUES ('Paul Cézanne','1839-01-19','1906-10-22','France','Un membre un temps du mouvement impressionniste et considéré comme le précurseur du post-impressionnisme et du cubisme.');

INSERT INTO courant_artistique (nom_courant, date_debut,date_fin,description)
  VALUES ('Impressionnisme',1874,1886,E'Ce mouvement pictural est principalement caractérisé par des tableaux de petit format, des traits de pinceau visibles, la composition ouverte, l\'utilisation d\'angles de vue inhabituels, une tendance à noter les impressions fugitives, la mobilité des phénomènes climatiques et lumineux, plutôt que l\'aspect stable et conceptuel des choses, et à les reporter directement sur la toile.');

INSERT INTO participation_courant (nom_courant,artiste)
  VALUES ('Impressionnisme','Paul Cézanne');


INSERT INTO musee (nom_musee , adresse , prix_entree ,pays)
  VALUES ('George Pompidou','15 rue de Paris 75001 Paris', 2.5 , 'France');

INSERT INTO expo_ids(expo_type) VALUES ('tempop');
INSERT INTO exposition_temporaire_pays (expo_id, nom_expo, musee, date_debut, date_fin, pays)
  VALUES ( currval('expo_ids_expo_id_seq'), 'Belle France', 'George Pompidou','2021-04-12','2021-10-18','France');

INSERT INTO expo_ids(expo_type) VALUES ('tempoa');
INSERT INTO exposition_temporaire_artiste (expo_id, nom_expo, musee, date_debut, date_fin, artiste)
  VALUES ( currval('expo_ids_expo_id_seq'), 'Cézanne et sa grandeur', 'George Pompidou','2021-02-26','2021-10-22','Paul Cézanne');

INSERT INTO expo_ids(expo_type) VALUES ('tempoc');
INSERT INTO exposition_temporaire_courant (expo_id, nom_expo, musee, date_debut, date_fin, courant)
  VALUES ( currval('expo_ids_expo_id_seq'), 'Impressionnisme impressionnant', 'George Pompidou','2021-06-10','2022-06-09','Impressionnisme');

INSERT INTO expo_ids(expo_type) VALUES ('perm');
INSERT INTO exposition_permanente (expo_id, nom_expo, musee)
  VALUES ( currval('expo_ids_expo_id_seq'), 'Les nouveaux arts', 'George Pompidou');

INSERT INTO oeuvre (nom_oeuvre,date,description,type , musee,exposition,artiste,courant_artistique)
  VALUES ('Les Grandes Baigneuses',1906,'tableau impressionniste','peinture','George Pompidou',1,'Paul Cézanne','Impressionnisme');

INSERT INTO oeuvre (nom_oeuvre,date,description,type , musee,exposition,artiste,courant_artistique)
  VALUES ('Le Garçon au gilet rouge',1890,'tableau impressionniste','peinture','George Pompidou',2,'Paul Cézanne','Impressionnisme');

INSERT INTO oeuvre (nom_oeuvre,date,description,type , musee,exposition,artiste,courant_artistique)
  VALUES ('Le panier de pommes',1893,'tableau impressionniste','peinture','George Pompidou',3,'Paul Cézanne','Impressionnisme');

INSERT INTO oeuvre (nom_oeuvre,date,description,type , musee,exposition,artiste,courant_artistique)
  VALUES ('Château Noir',1904,'tableau impressionniste','peinture','George Pompidou',4,'Paul Cézanne','Impressionnisme');

  // ajouter une contraine sur les expos temporaire que les oeuvres soient cohérentes
